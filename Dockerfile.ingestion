FROM python:3.12-slim

WORKDIR /app

# Install uv and cron
RUN pip install uv && apt-get update && apt-get install -y cron && rm -rf /var/lib/apt/lists/*

# Copy dependency files and README
COPY packages/ingestion/pyproject.toml ./pyproject.toml
COPY packages/ingestion/README.md ./README.md

# Create uv.lock
RUN uv lock

# Install dependencies
RUN uv sync --frozen

# Copy source code
COPY packages/ingestion/src/ ./src/

# Create the cron job script
RUN echo '#!/bin/bash\ncd /app && uv run python -m src.ingestion >> /var/log/ingestion.log 2>&1' > /app/run_ingestion.sh && chmod +x /app/run_ingestion.sh

# Add cron job (runs daily at 2 AM UTC)
RUN echo "0 2 * * * /app/run_ingestion.sh" | crontab -

# Create log file
RUN touch /var/log/ingestion.log

# Entry point: run initial sync then start cron
CMD ["sh", "-c", "uv run python -m src.ingestion --full-sync && cron && tail -f /var/log/ingestion.log"]
